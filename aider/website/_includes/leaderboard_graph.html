<canvas id="{{ include.chart_id }}" width="800" height="450" style="margin-top: 20px"></canvas>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var ctx = document.getElementById('{{ include.chart_id }}').getContext('2d');
    var leaderboardData = {
      labels: [],
      datasets: [{
        label: 'Percent completed correctly',
        data: [],
        backgroundColor: [],
        borderColor: [],
        borderWidth: 1
      }]
    };

    var allData = [];
    {% for row in include.data %}
      allData.push({
        model: '{{ row.model }}',
        pass_rate: {{ row[include.pass_rate_key] }},
        percent_cases_well_formed: {{ row.percent_cases_well_formed }},
        edit_format: '{{ row.edit_format }}'
      });
    {% endfor %}

    function updateChart() {
      var selectedRows = document.querySelectorAll('tr.selected');
      var showAll = selectedRows.length === 0;

      leaderboardData.labels = [];
      leaderboardData.datasets[0].data = [];
      leaderboardData.datasets[0].backgroundColor = [];
      leaderboardData.datasets[0].borderColor = [];

      allData.forEach(function(row, index) {
        var rowElement = document.getElementById('{{ include.row_prefix }}-' + index);
        if (showAll) {
          rowElement.classList.remove('selected');
        }
        if (showAll || rowElement.classList.contains('selected')) {
          leaderboardData.labels.push(row.model);
          leaderboardData.datasets[0].data.push(row.pass_rate);
          
          if (row.edit_format === 'whole') {
            leaderboardData.datasets[0].backgroundColor.push('rgba(255, 99, 132, 0.2)');
            leaderboardData.datasets[0].borderColor.push('rgba(255, 99, 132, 1)');
          } else {
            leaderboardData.datasets[0].backgroundColor.push('rgba(54, 162, 235, 0.2)');
            leaderboardData.datasets[0].borderColor.push('rgba(54, 162, 235, 1)');
          }
        }
      });

      // Apply legend filtering
      var meta = leaderboardChart.getDatasetMeta(0);
      meta.data.forEach(function(bar, index) {
        if (leaderboardData.labels.includes(allData[index].model)) {
          bar.hidden = (allData[index].edit_format === 'whole' && meta.data[0].hidden) ||
                       (allData[index].edit_format !== 'whole' && meta.data[1].hidden);
        } else {
          bar.hidden = true;
        }
      });

      leaderboardChart.update();
    }

    var tableBody = document.querySelector('table tbody');
    allData.forEach(function(row, index) {
      var tr = tableBody.children[index];
      tr.id = '{{ include.row_prefix }}-' + index;
      tr.style.cursor = 'pointer';
      tr.onclick = function() {
        this.classList.toggle('selected');
        updateChart();
      };
    });

    var leaderboardChart = new Chart(ctx, {
      type: 'bar',
      data: leaderboardData,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Correct Exercises (%)'
            }
          },
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 90,
              minRotation: 90
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              generateLabels: function(chart) {
                return [
                  {
                    text: 'whole',
                    fillStyle: 'rgba(255, 99, 132, 0.2)',
                    strokeStyle: 'rgba(255, 99, 132, 1)',
                    lineWidth: 1,
                    hidden: false
                  },
                  {
                    text: 'diff/udiff/diff-fenced',
                    fillStyle: 'rgba(54, 162, 235, 0.2)',
                    strokeStyle: 'rgba(54, 162, 235, 1)',
                    lineWidth: 1,
                    hidden: false
                  }
                ];
              }
            },
            onClick: function(e, legendItem, legend) {
              var index = legendItem.index;
              var ci = legend.chart;
              var alreadyHidden = (ci.getDatasetMeta(0).data[0].hidden === true);
              
              ci.data.datasets[0].data.forEach(function(dataPoint, i) {
                var meta = ci.getDatasetMeta(0);
                var shouldBeHidden = (index === 0 && allData[i].edit_format !== 'whole') || 
                                     (index === 1 && allData[i].edit_format === 'whole');
                meta.data[i].hidden = shouldBeHidden;
              });
              
              ci.update();
            }
          }
        }
      }
    });

    updateChart();
  });
</script>
